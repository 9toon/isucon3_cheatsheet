mysql の状態をみるコマンド集。

## query log

/etc/my.cnf

```
log=/var/log/mysql/mysql_query.log
```

ファイルを作っておく必要がある

```
$ sudo mkdir /var/log/mysql
$ sudo touch /var/log/mysql/mysql_query.log
$ sudo chown -R mysql /var/log/mysql
```

/etc/init.d/mysqld ＃やらなくても出る気がするけどな

```diff
- $exec   --datadir="$datadir" --socket="$socketfile" \
+ $exec --log --datadir="$datadir" --socket="$socketfile" \
```

cf. http://itchronicle.com/2012/10/20/63

## slow log

/etc/my.cnf

```
slow_query_log      = 1
slow_query_log_file = /var/lib/mysql/slow.log
long_query_time     = 0.1
log-queries-not-using-indexes
```

/var/lib/mysql/slow.log を見る. `log-queries-not-using-indexes` で index 使ってないやつがスロークエリとして出る。

mysqldumpslow を使ってレポートを出す. クエリの発行回数、平均時間(トータル時間)が見れる。-s c でカウント順、-s at で平均時間順、-s t でトータル時間順、-s ar で取得した平均行数順、-s r でトータル行数順にソートできる。

```
$ sudo mysqldumpslow -s t /var/lib/mysql/slow.log
Count: 665  Time=0.06s (40s)  Lock=0.00s (0s)  Rows=100.0 (66500), isucon[isucon]@localhost
  SELECT * FROM memos WHERE is_private=N ORDER BY created_at DESC, id DESC LIMIT N OFFSET N

Count: 1232  Time=0.02s (25s)  Lock=0.00s (0s)  Rows=110.3 (135858), isucon[isucon]@localhost
  SELECT id, content, is_private, created_at, updated_at FROM memos WHERE user=N  ORDER BY created_at

Count: 1227  Time=0.02s (23s)  Lock=0.00s (0s)  Rows=1.0 (1227), isucon[isucon]@localhost
  SELECT count(*) AS c FROM memos WHERE is_private=N
```


## mysql の内部状態

See [06.mysql_tmc.md](06.mysql_tmc.md)

## show processlist
これを数回～数十回叩いてみて、 よく出ているクエリは、遅かったり量が多かったりする「チューニング候補」になる。

```
show full processlist;
```

showprocesslist.sh 定期実行するスクリプト cf. http://treeapps.hatenablog.com/entry/20120124/p1

```bash
#!/bin/sh
interval=$1
# インターバルの単位は秒で初期値は1秒
test -z $interval && interval=1
watch -n $interval --differences "mysql -uroot -Dtest --table -Be 'show processlist;'"
```

## pt-query-digest

ブログ見てるとこれを使ってる人が多いみたい

- studioさん http://studio3104.hatenablog.com/entry/20121002/1349166827
- きょうへいさん http://muscle27.hateblo.jp/entry/2013/03/19/023638
